
-- In case clr needs to be enabled in your session
/*
Declare @@previousClrEnabled sql_variant
select @@previousClrEnabled = value from sys.configurations where name ='clr enabled'
 
EXEC sp_configure 'clr enabled' , '1'
RECONFIGURE
GO
*/

-- Request for the permission of type 'System.Security.Permissions.RegistryPermission, mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089' failed
/*
ALTER DATABASE Demos SET TRUSTWORTHY ON -- "TRUSTWORTHY ON" allows "EXTERNAL_ACCESS"
GO
*/


/* CREATING CLR IN A DATABASE

DECLARE @CLR_Dll_Directory NVARCHAR(500) -- Make sure to use you own dll file path
SET @CLR_Dll_Directory = 'D:\VSProjects\MovingFiles_CLR\MovingFiles_CLR\bin\Release\MovingFiles_CLR.dll'

CREATE ASSEMBLY [MovingFiles_CLR] from @CLR_Dll_Directory WITH PERMISSION_SET = EXTERNAL_ACCESS;
GO

CREATE PROCEDURE [dbo].[CLR_MoveFile]
	@FileName NVARCHAR (MAX), 
	@SourcePath NVARCHAR (MAX), 
	@DestinationSubFolder NVARCHAR (MAX), 
	@FilePrefix NVARCHAR (MAX), 
	@FileSuffix NVARCHAR (MAX), 
	@VersionLeadingZeroes INT, 
	@TestMode BIT, 
	@Success BIT OUTPUT, 
	@ReturnMessage NVARCHAR (MAX) OUTPUT, 
	@NewFileNameOut NVARCHAR (MAX) OUTPUT
AS EXTERNAL NAME [MovingFiles_CLR].[CLR_MoveFile.StoredProcedures].[CLR_MoveFile]
GO

*/

-- TESTING CLR

--input params
declare @FileName			NVARCHAR(100) = 'test.pdf'
declare @SourcePath			NVARCHAR(100) = 'D:\\TempArea\\FilesToMove'
declare @MoveToSubFolder	NVARCHAR(100) = 'Imported'

-- output params
declare @ReturnMessage	NVARCHAR(500) = ''
declare @Success		BIT
declare @NewFileNameOut	NVARCHAR(200) = ''
		
EXECUTE [dbo].[CLR_MoveFile]
		@FileName                  = @FileName
		,@SourcePath               = @SourcePath
		,@DestinationSubFolder     = @MoveToSubFolder
		,@FilePrefix               = 'Prefix_[date]_' 
		,@FileSuffix               = '_Suffix'
		,@TestMode                 = 1
		,@versionleadingzeroes     = 3
		,@Success                  = @Success  output
		,@ReturnMessage            = @ReturnMessage    output
		,@NewFileNameOut           = @NewFileNameOut   output
	    				   
select
	 @ReturnMessage		as '@ReturnMessage'
	,@Success			as '@Success'
	,@NewFileNameOut	as '@NewFileNameOut'